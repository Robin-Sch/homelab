Programming tips:

Dates: https://community.home-assistant.io/t/convert-date-and-time-template/99328/2
Loops: https://github.com/basnijholt/home-assistant-config/commit/57eca351a63ab6b0a160b964f2fe463a5eeb5677